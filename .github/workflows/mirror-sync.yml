name: Mirror Sync

on:
  push:
    branches: ['**']
    tags: ['**']
  delete:
    # Trigger on branch/tag deletion to sync deletions
  workflow_dispatch:
    inputs:
      full_sync:
        description: 'Perform full mirror sync (all branches and tags)'
        required: false
        default: 'false'
        type: boolean

jobs:
  mirror-push:
    name: Push to GitLab Mirror
    runs-on: ubuntu-latest
    # Only run on the main repo, not forks
    if: github.repository == 'hyperpolymath/branch-newspaper'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH for GitLab
        env:
          GITLAB_SSH_KEY: ${{ secrets.GITLAB_SSH_KEY }}
        run: |
          if [ -z "$GITLAB_SSH_KEY" ]; then
            echo "ERROR: GITLAB_SSH_KEY secret is not set"
            echo "Please add a deploy key to GitLab and store the private key as a GitHub secret"
            exit 1
          fi

          mkdir -p ~/.ssh
          echo "$GITLAB_SSH_KEY" > ~/.ssh/gitlab_key
          chmod 600 ~/.ssh/gitlab_key
          ssh-keyscan gitlab.com >> ~/.ssh/known_hosts

          cat >> ~/.ssh/config << EOF
          Host gitlab.com
            HostName gitlab.com
            User git
            IdentityFile ~/.ssh/gitlab_key
            StrictHostKeyChecking no
          EOF

      - name: Configure Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Add GitLab remote
        run: |
          git remote add gitlab git@gitlab.com:maa-framework/3-applications/branch-newspaper.git || true
          git remote set-url gitlab git@gitlab.com:maa-framework/3-applications/branch-newspaper.git

      - name: Push current ref to GitLab
        if: github.event_name == 'push'
        run: |
          REF="${GITHUB_REF}"
          echo "Pushing ref: $REF"

          # Retry logic with exponential backoff
          MAX_RETRIES=4
          RETRY_DELAY=2

          for i in $(seq 1 $MAX_RETRIES); do
            if git push gitlab "$REF" --force-with-lease; then
              echo "Successfully pushed $REF"
              exit 0
            fi
            if [ $i -lt $MAX_RETRIES ]; then
              echo "Push failed, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
          done

          echo "Failed to push after $MAX_RETRIES attempts"
          exit 1

      - name: Full mirror sync
        if: github.event.inputs.full_sync == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "Performing full mirror sync..."

          # Push all branches
          git push gitlab --all --force-with-lease

          # Push all tags
          git push gitlab --tags --force

          echo "Full sync complete!"

      - name: Handle deletion
        if: github.event_name == 'delete'
        run: |
          REF_TYPE="${{ github.event.ref_type }}"
          REF_NAME="${{ github.event.ref }}"

          echo "Handling deletion of $REF_TYPE: $REF_NAME"

          if [ "$REF_TYPE" = "branch" ]; then
            git push gitlab --delete "$REF_NAME" || echo "Branch may already be deleted"
          elif [ "$REF_TYPE" = "tag" ]; then
            git push gitlab --delete "refs/tags/$REF_NAME" || echo "Tag may already be deleted"
          fi

  verify-mirror:
    name: Verify Mirror Sync
    runs-on: ubuntu-latest
    needs: mirror-push
    if: always() && needs.mirror-push.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH for GitLab
        env:
          GITLAB_SSH_KEY: ${{ secrets.GITLAB_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$GITLAB_SSH_KEY" > ~/.ssh/gitlab_key
          chmod 600 ~/.ssh/gitlab_key
          ssh-keyscan gitlab.com >> ~/.ssh/known_hosts

          cat >> ~/.ssh/config << EOF
          Host gitlab.com
            HostName gitlab.com
            User git
            IdentityFile ~/.ssh/gitlab_key
            StrictHostKeyChecking no
          EOF

      - name: Add GitLab remote
        run: |
          git remote add gitlab git@gitlab.com:maa-framework/3-applications/branch-newspaper.git || true

      - name: Verify mirror sync
        env:
          SOURCE_REMOTE: origin
          DEST_REMOTE: gitlab
        run: ./ci-scripts/verify-mirror.sh
